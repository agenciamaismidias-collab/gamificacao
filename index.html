<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Avaliação de Pautas</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .crown-icon { filter: drop-shadow(0px 2px 4px rgba(234, 179, 8, 0.5)); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signOut, onAuthStateChanged, signInAnonymously
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, setDoc, addDoc, getDoc, 
            query, onSnapshot, where, serverTimestamp, deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { 
            Settings, Users, Briefcase, ListTodo, ClipboardList, BarChart3, User, LogOut, 
            ArrowLeft, Plus, Check, Building, Trash2, Pencil, X, Calendar as CalendarIcon, 
            Flag, AlertTriangle, Lock, ShieldCheck, UserCircle, UserPlus, Eye, Crown, Star
        } from "https://esm.sh/lucide-react@0.292.0";

        const { useState, useEffect, useMemo } = React;

        // --- CONFIGURAÇÃO ---
        const appId = 'sistema-avaliacao-pautas';
        
        // LISTA DE SUPER ADMINS - Garante acesso total independente do banco
        const SUPER_ADMINS = ['sabrinacruz.mkt@gmail.com'];
        
        const firebaseConfig = {
            apiKey: "AIzaSyBZ76yd8RbRQVjbJ115QqL3oDztxedq0OY",
            authDomain: "agmm-16a91.firebaseapp.com",
            projectId: "agmm-16a91",
            storageBucket: "agmm-16a91.firebasestorage.app",
            messagingSenderId: "784096179999",
            appId: "1:784096179999:web:68597a2a52a668e224622a",
            measurementId: "G-9K9X7QT5SS"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // App Secundária para criar usuários sem deslogar o admin atual
        const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
        const secondaryAuth = getAuth(secondaryApp);

        const getPublicCollectionPath = (name) => `artifacts/${appId}/public/data/${name}`;
        const formatDate = (d) => {
            if(!d) return 'N/A';
            if(d.toDate) return d.toDate().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', year:'numeric'});
            try { const [y,m,d] = d.split('-'); return `${d}/${m}/${y}`; } catch { return 'N/A'; }
        };

        // --- COMPONENTES UI ---
        const Card = ({ children, title, icon: Icon, className = "" }) => (
            <div className={`bg-white p-6 rounded-xl shadow-sm border border-gray-200 ${className}`}>
                {title && <h2 className="flex items-center text-lg font-bold text-gray-800 mb-4 border-b border-gray-100 pb-2">{Icon && <Icon className="w-5 h-5 mr-2 text-indigo-600" />}{title}</h2>}
                {children}
            </div>
        );

        const Button = ({ children, onClick, disabled, icon: Icon, type = "primary", size = "md", className = "" }) => {
            let base = "flex items-center justify-center font-medium rounded-lg transition-all duration-200 disabled:opacity-50 ";
            if (size === 'sm') base += "px-3 py-1.5 text-xs "; else if (size === 'icon') base += "p-2 "; else base += "px-4 py-2 text-sm ";
            const colors = {
                secondary: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50",
                danger: "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100",
                ghost: "text-gray-500 hover:bg-gray-100 border-transparent",
                primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm"
            };
            return <button onClick={onClick} disabled={disabled} className={`${base} ${colors[type] || colors.primary} ${className}`}>{Icon && <Icon className={`w-4 h-4 ${children?'mr-2':''}`}/>}{children}</button>;
        };

        const Input = ({ label, type="text", value, onChange, required, className="" }) => (
            <div className="mb-4">
                {label && <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">{label} {required && <span className="text-red-500">*</span>}</label>}
                <input type={type} value={value} onChange={onChange} required={required} className={`w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none ${className}`} />
            </div>
        );

        const MonthSelector = ({ selectedMonth, setSelectedMonth }) => (
            <div className="flex items-center space-x-2 bg-white p-1 rounded-lg border border-gray-200 shadow-sm">
                <label htmlFor="month-select" className="text-xs font-medium text-gray-500 pl-2">Mês:</label>
                <input type="month" id="month-select" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="text-sm border-none focus:ring-0 bg-transparent text-gray-700 font-medium cursor-pointer outline-none" />
            </div>
        );

        // --- TELA DE LOGIN (SELEÇÃO DE PERFIL + LOGIN REAL) ---
        const LoginScreen = ({ onRoleSelect }) => {
            const [step, setStep] = useState(1);
            const [role, setRole] = useState(null);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [name, setName] = useState('');

            const handleRoleClick = (selectedRole) => {
                setRole(selectedRole);
                onRoleSelect(selectedRole); // Notifica o App sobre a intenção
                setStep(2);
                setError('');
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true); 
                setError('');
                try {
                    if (isRegistering) {
                        const cred = await createUserWithEmailAndPassword(auth, email, password);
                        // Força admin se for o email do super admin
                        const isSuper = SUPER_ADMINS.includes(email);
                        await setDoc(doc(db, `artifacts/${appId}/public/data/funcionarios`, cred.user.uid), {
                            id: cred.user.uid, nome: name, email: email, isAdmin: isSuper, cargoId: '', clienteIds: [], timestamp: serverTimestamp()
                        });
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setError("Erro: " + err.message);
                    setLoading(false);
                }
            };

            if(step === 1) return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
                    <div className="text-center mb-10">
                        <h1 className="text-4xl font-bold text-indigo-900 mb-2 tracking-tight">Sistema de Pautas</h1>
                        <p className="text-gray-500">Selecione seu perfil de acesso</p>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl w-full mb-8">
                        <div onClick={()=>handleRoleClick('admin')} className="bg-white p-8 rounded-2xl shadow-sm border cursor-pointer hover:border-indigo-500 transition group text-center hover:shadow-md">
                            <div className="bg-indigo-50 p-4 rounded-full mb-4 mx-auto w-16 group-hover:bg-indigo-100 transition"><ShieldCheck className="w-8 h-8 text-indigo-600"/></div>
                            <h2 className="text-xl font-bold text-gray-800">Administrador</h2>
                            <p className="text-sm text-gray-500 mt-2">Gestão e Validação</p>
                        </div>
                        <div onClick={()=>handleRoleClick('employee')} className="bg-white p-8 rounded-2xl shadow-sm border cursor-pointer hover:border-green-500 transition group text-center hover:shadow-md">
                            <div className="bg-green-50 p-4 rounded-full mb-4 mx-auto w-16 group-hover:bg-green-100 transition"><UserCircle className="w-8 h-8 text-green-600"/></div>
                            <h2 className="text-xl font-bold text-gray-800">Funcionário</h2>
                            <p className="text-sm text-gray-500 mt-2">Produção e Lançamentos</p>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                    <Card className="w-full max-w-md relative border-0 shadow-xl">
                        <button onClick={()=>{setStep(1); setIsRegistering(false);}} className="absolute top-6 left-6 text-gray-400 hover:text-gray-600 flex items-center text-xs uppercase font-bold"><ArrowLeft className="w-3 h-3 mr-1"/> Voltar</button>
                        <div className="text-center mb-8 mt-4">
                            <h1 className="text-2xl font-bold text-gray-800">Login {role === 'admin' ? 'Admin' : ''}</h1>
                            <p className="text-gray-500 text-sm">Insira suas credenciais</p>
                        </div>
                        <form onSubmit={handleAuth}>
                            {isRegistering && <Input label="Nome" value={name} onChange={e=>setName(e.target.value)} required />}
                            <Input label="E-mail" type="email" value={email} onChange={e=>setEmail(e.target.value)} required />
                            <Input label="Senha" type="password" value={password} onChange={e=>setPassword(e.target.value)} required />
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center border border-red-100">{error}</div>}
                            <Button className="w-full h-10" disabled={loading}>{loading ? 'Processando...' : (isRegistering ? 'Criar Conta' : 'Entrar')}</Button>
                        </form>
                        <div className="text-center mt-4 pt-4 border-t border-gray-100">
                            <button onClick={() => { setIsRegistering(!isRegistering); setError(''); }} className="text-xs text-gray-500 hover:text-indigo-600 font-medium">
                                {isRegistering ? 'Já possui conta? Faça Login' : 'Não tem acesso? Cadastre-se aqui'}
                            </button>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- GRÁFICOS E VISUALIZAÇÕES ---
        const RankingChart = ({ data }) => {
            const maxScore = Math.max(...data.map(f => f.score || 0), 1); 
            return (
                <div className="space-y-4">
                    {data.map((f, index) => {
                        const isFirst = index === 0;
                        return (
                            <div key={f.id} className={`relative p-3 rounded-xl border transition-all ${isFirst ? 'bg-yellow-50 border-yellow-200 shadow-sm' : 'bg-white border-gray-100 hover:shadow-sm'}`}>
                                <div className="flex justify-between items-center mb-2 z-10 relative">
                                    <div className="flex items-center gap-2">
                                        {isFirst ? <div className="w-6 h-6 flex items-center justify-center bg-yellow-100 rounded-full text-yellow-600 crown-icon"><Crown className="w-4 h-4 fill-current" /></div> : <div className="w-6 h-6 flex items-center justify-center bg-gray-100 rounded-full text-gray-500 text-xs font-bold">{index + 1}</div>}
                                        <span className={`font-semibold ${isFirst ? 'text-yellow-800' : 'text-gray-700'}`}>{f.nome}</span>
                                    </div>
                                    <span className={`font-bold text-sm ${isFirst ? 'text-yellow-700' : 'text-indigo-600'}`}>{f.score}%</span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden"><div className={`h-full rounded-full transition-all duration-500 ${isFirst ? 'bg-yellow-400' : 'bg-indigo-500'}`} style={{ width: f.score > 0 ? `${f.score}%` : '2%' }}></div></div>
                                {f.totalPenalidades > 0 && <div className="mt-1 flex justify-end"><span className="text-[10px] text-red-500 bg-red-50 px-1.5 py-0.5 rounded flex items-center"><Flag className="w-3 h-3 mr-1" /> -{f.totalPenalidades} pts</span></div>}
                            </div>
                        );
                    })}
                    {data.length === 0 && <p className="text-center text-gray-400 text-sm py-4">Sem dados de ranking.</p>}
                </div>
            );
        };

        const AdminView = ({ db, userId, cargos, funcionarios, atividades, lancamentos, clientes, bandeiras, logout, month, setMonth }) => {
            const [tab, setTab] = useState('dashboard');
            const [showUserModal, setShowUserModal] = useState(false);
            
            const dashData = useMemo(() => {
                const d = funcionarios.map(f => ({ ...f, pts: 0, max: 0, count: 0, flags: 0, score: 0 }));
                lancamentos.filter(l=>l.status==='Validado').forEach(l => {
                    const idx = d.findIndex(x=>x.id===l.funcionarioId);
                    if(idx > -1) {
                        const atv = atividades.find(a=>a.id===l.atividadeBaseId);
                        d[idx].pts += Number(l.pontuacaoAtribuida||0);
                        d[idx].max += (atv?.pontuacaoMaxima||1);
                        d[idx].count++;
                    }
                });
                bandeiras.forEach(b => {
                    const idx = d.findIndex(x=>x.id===b.funcionarioId);
                    if(idx > -1) { d[idx].flags++; d[idx].pts -= 1; }
                });
                return d.map(x => ({ ...x, pts: Math.max(0, x.pts), score: x.max > 0 ? ((Math.max(0, x.pts)/x.max)*100).toFixed(0) : 0 })).sort((a,b)=>b.score-a.score);
            }, [funcionarios, lancamentos, bandeiras, atividades]);

            // Criação de Usuário pelo Admin (usando Auth Secundário)
            const handleCreateUser = async (data) => {
                try {
                    const cred = await createUserWithEmailAndPassword(secondaryAuth, data.email, data.password);
                    await setDoc(doc(db, getPublicCollectionPath('funcionarios'), cred.user.uid), {
                        id: cred.user.uid, nome: data.nome, email: data.email, cargoId: data.cargoId, clienteIds: data.cliIds, isAdmin: data.isAdmin, criadoPor: userId, timestamp: serverTimestamp()
                    });
                    await signOut(secondaryAuth); // Limpa a sessão secundária
                    alert("Usuário criado com sucesso!"); setShowUserModal(false);
                } catch(e) { alert("Erro ao criar usuário: " + e.message); }
            };

            const handleAdd = async (col, data) => addDoc(collection(db, getPublicCollectionPath(col)), { ...data, criadoPor: userId, timestamp: serverTimestamp() });
            const handleDel = async (col, id) => { if(confirm('Excluir?')) deleteDoc(doc(db, getPublicCollectionPath(col), id)); };
            const handleVal = async (l, score) => setDoc(doc(db, getPublicCollectionPath('lancamentos'), l.id), { status: 'Validado', pontuacaoAtribuida: score, validadorId: userId }, {merge:true});

            return (
                <div className="p-6 min-h-screen max-w-7xl mx-auto">
                    <header className="flex justify-between items-center mb-8 pb-4 border-b"><h1 className="text-3xl font-bold text-gray-800 flex items-center"><Settings className="mr-3 text-indigo-600"/> Admin</h1><div className="flex gap-4"><input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border rounded p-2"/><Button onClick={logout} type="secondary" icon={LogOut}>Sair</Button></div></header>
                    <div className="flex gap-2 mb-8 overflow-x-auto pb-2">{[{id:'dashboard',label:'Dashboard',icon:BarChart3},{id:'validacao',label:'Validação',icon:ClipboardList},{id:'cadastros',label:'Cadastros',icon:Briefcase}].map(t=><button key={t.id} onClick={()=>setTab(t.id)} className={`px-5 py-2 rounded-full text-sm flex items-center ${tab===t.id?'bg-indigo-600 text-white':'bg-white border'}`}><t.icon className="w-4 h-4 mr-2"/>{t.label}</button>)}</div>
                    
                    {tab==='dashboard' && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <Card title="Ranking de Desempenho" className="md:col-span-1 h-full"><RankingChart data={dashData} /></Card>
                            <Card title="Detalhes Individuais" className="md:col-span-2"><div className="space-y-3 max-h-[60vh] overflow-y-auto">{dashData.map(f=><div key={f.id} className="p-4 border rounded bg-white hover:bg-gray-50 transition"><div className="flex justify-between font-bold mb-2"><span>{f.nome}</span><span className={f.score >= 90 ? "text-green-600" : "text-gray-600"}>{f.score}%</span></div><div className="text-sm text-gray-600 flex justify-between"><span>Pontos: {f.pts}/{f.max}</span>{f.flags>0 && <span className="text-red-600 font-semibold flex items-center"><Flag className="w-3 h-3 mr-1"/>{f.flags} Penalidade(s)</span>}</div></div>)}</div></Card>
                        </div>
                    )}

                    {tab==='validacao' && (
                        <Card title="Pendentes" icon={ClipboardList}>
                            <div className="space-y-4">
                                {lancamentos.filter(l=>l.status==='Pendente').map(l => {
                                    const atv = atividades.find(a=>a.id===l.atividadeBaseId);
                                    const func = funcionarios.find(f=>f.id===l.funcionarioId);
                                    return <div key={l.id} className="flex justify-between items-center p-3 border rounded"><div><p className="font-bold">{atv?.nome}</p><p className="text-sm">{func?.nome} - {formatDate(l.dataConclusao)}</p></div><div className="flex gap-2"><Button size="sm" onClick={()=>handleVal(l, atv?.pontuacaoMaxima)} icon={Check}>Validar (Max)</Button></div></div>
                                })}
                                {lancamentos.filter(l=>l.status==='Pendente').length === 0 && <p className="text-center text-gray-500">Nada pendente.</p>}
                            </div>
                        </Card>
                    )}

                    {tab==='cadastros' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <SimpleForm title="Cargos" onAdd={n=>handleAdd('cargos',{nome:n})} list={cargos} onDel={id=>handleDel('cargos',id)} />
                            <SimpleForm title="Atividades" onAdd={n=>handleAdd('atividadesBase',{nome:n, pontuacaoMaxima:1})} list={atividades} onDel={id=>handleDel('atividadesBase',id)} extraFields={true} cargos={cargos} />
                            <SimpleForm title="Clientes" onAdd={n=>handleAdd('clientes',{nome:n})} list={clientes} onDel={id=>handleDel('clientes',id)} />
                            <Card title="Funcionários" icon={Users}>
                                <div className="flex justify-between items-center mb-4"><span className="text-sm text-gray-500">Total: {funcionarios.length}</span><Button size="sm" icon={UserPlus} onClick={()=>setShowUserModal(true)}>Novo</Button></div>
                                <div className="space-y-2 max-h-60 overflow-y-auto">{funcionarios.map(f=><div key={f.id} className="flex justify-between p-3 border rounded items-center text-sm bg-white"><div><p className="font-semibold">{f.nome}</p><p className="text-xs text-gray-500">{f.email}</p></div><button onClick={()=>handleDel('funcionarios', f.id)} className="text-red-500 hover:bg-red-50 p-1 rounded transition"><Trash2 className="w-4 h-4"/></button></div>)}</div>
                            </Card>
                        </div>
                    )}
                    {showUserModal && <CreateUserModal onClose={()=>setShowUserModal(false)} onSave={handleCreateUser} cargos={cargos} clientes={clientes} />}
                </div>
            );
        };

        const EmployeeView = ({ db, userId, user, cargos, atividades, lancamentos, clientes, bandeiras, logout, month, setMonth }) => {
            const [form, setForm] = useState({ atvId: '', cliId: '', date: '', desc: '' });
            const cargo = cargos.find(c=>c.id===user.cargoId);
            const myLancs = lancamentos.filter(l=>l.funcionarioId===userId);
            const myFlags = bandeiras.filter(b=>b.funcionarioId===userId);
            const myAtvs = atividades.filter(a=>a.cargoId===user.cargoId);
            const myClis = clientes.filter(c=>(user.clienteIds||[]).includes(c.id));

            const totalScore = useMemo(() => {
                const points = myLancs.filter(l => l.status === 'Validado').reduce((acc, curr) => acc + Number(curr.pontuacaoAtribuida || 0), 0);
                const penaltyPoints = myFlags.length;
                return Math.max(0, points - penaltyPoints);
            }, [myLancs, myFlags]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, getPublicCollectionPath('lancamentos')), {
                    funcionarioId: userId, atividadeBaseId: form.atvId, clienteId: form.cliId, dataConclusao: form.date, descricao: form.desc,
                    status: 'Pendente', pontuacaoAtribuida: 0, dataLancamento: serverTimestamp()
                });
                setForm({ atvId: '', cliId: '', date: '', desc: '' }); alert("Enviado!");
            };

            return (
                <div className="p-6 min-h-screen max-w-7xl mx-auto">
                    <header className="flex justify-between items-center mb-8 pb-4 border-b"><h1 className="text-2xl font-bold text-indigo-800 flex items-center"><User className="mr-2"/> {user.nome}</h1><div className="flex gap-4"><input type="month" value={month} onChange={e=>setMonth(e.target.value)} className="border rounded p-2"/><Button onClick={logout} type="secondary" icon={LogOut}>Sair</Button></div></header>
                    <div className="mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <Card className="bg-indigo-50 border-indigo-100"><div className="flex justify-between items-center"><div><p className="text-sm font-bold text-gray-500 uppercase">Cargo</p><p className="text-xl text-indigo-700">{cargo?.nome || '-'}</p></div>{myFlags.length > 0 && <div className="bg-red-100 text-red-700 px-4 py-2 rounded border border-red-200 flex items-center"><AlertTriangle className="w-5 h-5 mr-2"/>{myFlags.length} Penalidades</div>}</div></Card>
                        <Card className="bg-green-50 border-green-100"><div className="flex items-center justify-between"><div><p className="text-sm font-bold text-gray-500 uppercase">Pontuação Acumulada</p><p className="text-3xl font-extrabold text-green-700">{totalScore} pts</p></div><div className="bg-green-200 p-3 rounded-full text-green-800"><Star className="w-8 h-8 fill-current" /></div></div></Card>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <Card title="Novo Lançamento" icon={Plus}>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div><label className="text-xs font-bold text-gray-500">Cliente</label><select className="w-full border rounded p-2" value={form.cliId} onChange={e=>setForm({...form, cliId:e.target.value})}><option value="">Selecione...</option>{myClis.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}</select></div>
                                <div>
                                    <label className="text-xs font-bold text-gray-500">Atividade</label>
                                    <select className="w-full border rounded p-2" value={form.atvId} onChange={e=>setForm({...form, atvId:e.target.value})} required>
                                        <option value="">Selecione...</option>
                                        {/* MOSTRA APENAS O NOME, SEM PONTOS */}
                                        {myAtvs.map(a=><option key={a.id} value={a.id}>{a.nome}</option>)}
                                    </select>
                                </div>
                                <Input label="Data" type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} required />
                                <Button className="w-full">Lançar</Button>
                            </form>
                        </Card>
                        <Card title="Histórico" icon={ClipboardList} className="md:col-span-2">
                            <div className="space-y-2 max-h-80 overflow-y-auto">{myLancs.map(l=><div key={l.id} className="p-3 border rounded bg-white flex justify-between items-center"><span>{atividades.find(a=>a.id===l.atividadeBaseId)?.nome} <span className="text-xs text-gray-400 ml-2">{formatDate(l.dataConclusao)}</span></span><span className={`text-xs px-2 py-1 rounded ${l.status==='Validado'?'bg-green-100 text-green-700':'bg-yellow-100 text-yellow-700'}`}>{l.status}</span></div>)}</div>
                        </Card>
                    </div>
                </div>
            );
        };

        const SimpleForm = ({ title, list, onAdd, onDel, extraFields, cargos }) => {
            const [val, setVal] = useState(''); const [cid, setCid] = useState(''); 
            return (
                <Card title={title} icon={ListTodo}>
                    <div className="flex gap-2 mb-4">
                        <Input value={val} onChange={e=>setVal(e.target.value)} placeholder="Nome" className="mb-0 flex-1"/>
                        {extraFields && <select className="border rounded px-2 w-1/3" value={cid} onChange={e=>setCid(e.target.value)}><option value="">Cargo</option>{cargos?.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}</select>}
                        <Button size="sm" onClick={()=>{onAdd(val); setVal('')}}>+</Button>
                    </div>
                    <div className="space-y-1 max-h-40 overflow-y-auto">{list.map(i=><div key={i.id} className="flex justify-between p-2 border rounded text-sm bg-gray-50"><span>{i.nome}</span><button onClick={()=>onDel(i.id)} className="text-red-500"><Trash2 className="w-4 h-4"/></button></div>)}</div>
                </Card>
            );
        };

        const CreateUserModal = ({ onClose, onSave, cargos, clientes }) => {
            const [d, setD] = useState({ nome:'', email:'', password:'', cargoId:'', cliIds:[], isAdmin: false });
            const toggle = (id) => setD(p => ({...p, cliIds: p.cliIds.includes(id)?p.cliIds.filter(x=>x!==id):[...p.cliIds, id]}));
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
                    <div className="bg-white p-6 rounded-xl w-full max-w-md shadow-xl max-h-[90vh] overflow-y-auto">
                        <h2 className="text-lg font-bold mb-4">Novo Funcionário</h2>
                        <form onSubmit={e=>{e.preventDefault(); onSave(d);}}>
                            <Input label="Nome" value={d.nome} onChange={e=>setD({...d, nome:e.target.value})} required />
                            <Input label="Email" value={d.email} onChange={e=>setD({...d, email:e.target.value})} required />
                            <Input label="Senha" type="password" value={d.password} onChange={e=>setD({...d, password:e.target.value})} required />
                            <div className="mb-4"><label className="block text-xs font-bold text-gray-500">Cargo</label><select className="w-full border rounded p-2" value={d.cargoId} onChange={e=>setD({...d, cargoId:e.target.value})}><option value="">Selecione...</option>{cargos.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}</select></div>
                            <div className="mb-4"><label className="block text-xs font-bold text-gray-500">Clientes</label><div className="flex flex-wrap gap-2 mt-1">{clientes.map(c=><span key={c.id} onClick={()=>toggle(c.id)} className={`text-xs border px-2 py-1 rounded cursor-pointer ${d.cliIds.includes(c.id)?'bg-indigo-100 border-indigo-300 text-indigo-700':''}`}>{c.nome}</span>)}</div></div>
                            <label className="flex items-center gap-2 mb-6 text-sm"><input type="checkbox" checked={d.isAdmin} onChange={e=>setD({...d, isAdmin:e.target.checked})} /> Acesso Admin</label>
                            <div className="flex justify-end gap-2"><Button type="secondary" onClick={onClose}>Cancelar</Button><Button>Salvar</Button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const AccessDenied = ({ onBack }) => (
            <div className="flex h-screen flex-col items-center justify-center bg-red-50 text-center p-6">
                <div className="bg-red-100 p-4 rounded-full mb-4"><AlertTriangle className="w-12 h-12 text-red-600"/></div>
                <h1 className="text-2xl font-bold text-red-700 mb-2">Acesso Negado</h1>
                <p className="text-gray-600 mb-6">Esta conta não tem permissão de administrador.</p>
                <Button onClick={onBack} type="danger">Voltar</Button>
            </div>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [targetRole, setTargetRole] = useState(null);
            const [month, setMonth] = useState(new Date().toISOString().slice(0,7));

            // Dados
            const [cargos, setCargos] = useState([]);
            const [atividades, setAtividades] = useState([]);
            const [funcs, setFuncs] = useState([]);
            const [lancs, setLancs] = useState([]);
            const [clis, setClis] = useState([]);
            const [flags, setFlags] = useState([]);

            useEffect(() => onAuthStateChanged(auth, u => {
                setUser(u); 
                if(!u) { setProfile(null); setTargetRole(null); setLoading(false); }
            }), []);

            useEffect(() => {
                if(user) {
                    const unsubP = onSnapshot(doc(db, getPublicCollectionPath('funcionarios'), user.uid), d => {
                        if(d.exists()) {
                            const data = d.data();
                            if(SUPER_ADMINS.includes(data.email)) data.isAdmin = true;
                            setProfile(data);
                        } else {
                            // Fallback seguro para não quebrar a UI
                            setProfile({ id: user.uid, nome: user.email || 'Usuário', email: user.email || '', isAdmin: false });
                        }
                        setLoading(false);
                    });
                    const q = (n) => query(collection(db, getPublicCollectionPath(n)));
                    const uC = onSnapshot(q('cargos'), s => setCargos(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uA = onSnapshot(q('atividadesBase'), s => setAtividades(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uF = onSnapshot(q('funcionarios'), s => setFuncs(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uL = onSnapshot(q('lancamentos'), s => setLancs(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uCl = onSnapshot(q('clientes'), s => setClis(s.docs.map(d=>({id:d.id,...d.data()}))));
                    const uFl = onSnapshot(q('bandeiras'), s => setFlags(s.docs.map(d=>({id:d.id,...d.data()}))));
                    return () => { unsubP(); uC(); uA(); uF(); uL(); uCl(); uFl(); };
                }
            }, [user]);

            const filteredLancs = useMemo(() => lancs.filter(l => !l.dataConclusao || l.dataConclusao.startsWith(month)), [lancs, month]);
            const filteredFlags = useMemo(() => flags.filter(f => !f.data || f.data.startsWith(month)), [flags, month]);

            const handleRoleSelect = async (role) => {
                setTargetRole(role); 
                setLoading(false); // Permite mostrar a tela de login
            };

            const handleLogout = () => { signOut(auth); setTargetRole(null); };

            if(loading) return <div className="flex h-screen items-center justify-center font-bold text-indigo-600 animate-pulse">Carregando...</div>;
            
            if(!user) return <LoginScreen onRoleSelect={handleRoleSelect} />;

            // Roteamento
            if(targetRole === 'admin') {
                if(profile && !profile.isAdmin) return <AccessDenied onBack={handleLogout} />;
                return <AdminView db={db} userId={user.uid} cargos={cargos} funcionarios={funcs} atividades={atividades} lancamentos={filteredLancs} clientes={clis} bandeiras={filteredFlags} logout={handleLogout} month={month} setMonth={setMonth} />;
            }

            return <EmployeeView db={db} userId={user.uid} user={profile} cargos={cargos} atividades={atividades} lancamentos={filteredLancs} clientes={clis} bandeiras={filteredFlags} logout={handleLogout} month={month} setMonth={setMonth} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
