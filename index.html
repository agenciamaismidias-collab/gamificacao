<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Avaliação de Pautas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons (Global) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Ajustes finos para scroll */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- IMPORTAÇÕES DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, setDoc, addDoc, getDoc, 
            query, onSnapshot, where, serverTimestamp, runTransaction, 
            deleteDoc, getDocs
        } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // --- IMPORTAÇÕES DO LUCIDE REACT ---
        import { 
            Settings, Users, Briefcase, ListTodo, ClipboardList, Zap, 
            BarChart3, User, LogOut, ArrowLeft, Plus, Check, Building, 
            Trash2, Pencil, X, Calendar as CalendarIcon, Flag, AlertTriangle, 
            Lock, Mail, ChevronLeft, ChevronRight, ShieldCheck, UserCircle, UserPlus
        } from "https://esm.sh/lucide-react@0.292.0";

        const React = window.React;
        const useState = React.useState;
        const useEffect = React.useEffect;
        const useMemo = React.useMemo;
        const useCallback = React.useCallback;

        // --- CONFIGURAÇÃO GERAL ---
        const appId = 'sistema-avaliacao-pautas';
        const SUPER_ADMINS = ['sabrinacruz.mkt@gmail.com'];

        const firebaseConfig = {
            apiKey: "AIzaSyBZ76yd8RbRQVjbJ115QqL3oDztxedq0OY",
            authDomain: "agmm-16a91.firebaseapp.com",
            projectId: "agmm-16a91",
            storageBucket: "agmm-16a91.firebasestorage.app",
            messagingSenderId: "784096179999",
            appId: "1:784096179999:web:68597a2a52a668e224622a",
            measurementId: "G-9K9X7QT5SS"
        };

        // --- INICIALIZAÇÃO DO FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ** TRUQUE PARA CRIAR USUÁRIO SEM DESLOGAR O ADMIN **
        // Inicializamos uma "App Secundária". Usaremos o auth dela apenas para criar usuários.
        const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
        const secondaryAuth = getAuth(secondaryApp);

        // --- FUNÇÕES UTILITÁRIAS ---
        const getPublicCollectionPath = (collectionName) => {
            return `artifacts/${appId}/public/data/${collectionName}`;
        };

        const formatDate = (data) => {
            if (!data) return 'N/A';
            if (data.toDate) { 
                return data.toDate().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            try {
                const [year, month, day] = data.split('-');
                return `${day}/${month}/${year}`;
            } catch {
                return 'N/A';
            }
        };

        // --- COMPONENTES DE UI (REFINADOS) ---
        const Card = ({ children, title, icon: Icon, className = "" }) => (
            <div className={`bg-white p-6 rounded-xl shadow-sm border border-gray-200 ${className}`}>
                {title && (
                    <h2 className="flex items-center text-lg font-bold text-gray-800 mb-4 border-b border-gray-100 pb-2">
                        {Icon && <Icon className="w-5 h-5 mr-2 text-indigo-600" />}
                        {title}
                    </h2>
                )}
                {children}
            </div>
        );

        // Botão com estilo mais delicado e variantes
        const Button = ({ children, onClick, disabled = false, icon: Icon, type = "primary", size = "md", className = "" }) => {
            let baseClasses = "flex items-center justify-center font-medium rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed ";
            
            // Tamanhos
            if (size === 'sm') baseClasses += "px-3 py-1.5 text-xs ";
            else if (size === 'icon') baseClasses += "p-2 ";
            else baseClasses += "px-4 py-2 text-sm ";

            // Cores/Tipos
            let colorClasses = "";
            switch (type) {
                case 'secondary': 
                    colorClasses = "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 hover:border-gray-400 shadow-sm"; 
                    break;
                case 'danger': 
                    colorClasses = "bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 hover:border-red-300"; 
                    break;
                case 'ghost':
                    colorClasses = "text-gray-500 hover:bg-gray-100 hover:text-gray-700 border-transparent";
                    break;
                default: // primary
                    colorClasses = "bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm border border-transparent"; 
                    break;
            }

            return (
                <button onClick={onClick} disabled={disabled} className={`${baseClasses} ${colorClasses} ${className}`}>
                    {Icon && <Icon className={`w-4 h-4 ${children ? 'mr-2' : ''}`} />}
                    {children}
                </button>
            );
        };

        const Input = ({ label, type = "text", value, onChange, placeholder = "", min, max, required = false, className = "" }) => (
            <div className="mb-4">
                {label && <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">{label} {required && <span className="text-red-500">*</span>}</label>}
                <input
                    type={type}
                    value={value || ''}
                    onChange={onChange}
                    placeholder={placeholder}
                    min={min}
                    max={max}
                    required={required}
                    className={`w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none ${className}`}
                />
            </div>
        );

        const MonthSelector = ({ selectedMonth, setSelectedMonth }) => (
            <div className="flex items-center space-x-2 bg-white p-1 rounded-lg border border-gray-200 shadow-sm">
                <label htmlFor="month-select" className="text-xs font-medium text-gray-500 pl-2">Mês:</label>
                <input
                    type="month"
                    id="month-select"
                    value={selectedMonth}
                    onChange={(e) => setSelectedMonth(e.target.value)}
                    className="text-sm border-none focus:ring-0 bg-transparent text-gray-700 font-medium cursor-pointer outline-none"
                />
            </div>
        );

        // --- TELA DE LOGIN UNIFICADA ---
        const LoginScreen = ({ setTargetRole }) => {
            const [step, setStep] = useState(1); 
            const [role, setRole] = useState(null);
            const [isRegistering, setIsRegistering] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleRoleSelect = (selectedRole) => {
                setRole(selectedRole);
                setTargetRole(selectedRole);
                setStep(2);
                setError('');
            };

            const handleBack = () => {
                setStep(1);
                setRole(null);
                setTargetRole(null);
                setError('');
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);

                try {
                    if (isRegistering) {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        const isSuper = SUPER_ADMINS.includes(email);
                        
                        await setDoc(doc(db, getPublicCollectionPath('funcionarios'), user.uid), {
                            id: user.uid,
                            nome: name,
                            email: email,
                            isAdmin: isSuper, 
                            cargoId: '', 
                            clienteIds: [],
                            timestamp: serverTimestamp()
                        });
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    console.error("Erro:", err);
                    let msg = "Erro ao autenticar: " + err.message;
                    if (err.code === 'auth/email-already-in-use') msg = "Este e-mail já está em uso.";
                    if (err.code === 'auth/weak-password') msg = "A senha deve ter pelo menos 6 caracteres.";
                    if (err.code === 'auth/invalid-credential') msg = "E-mail ou senha incorretos.";
                    setError(msg);
                    setLoading(false);
                }
            };

            if (step === 1) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4">
                        <div className="text-center mb-10">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2 tracking-tight">Sistema de Pautas</h1>
                            <p className="text-gray-500">Selecione seu perfil de acesso</p>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl w-full">
                            <div onClick={() => handleRoleSelect('admin')} className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 cursor-pointer hover:border-indigo-500 hover:shadow-md transition-all group flex flex-col items-center text-center">
                                <div className="bg-indigo-50 p-4 rounded-full mb-4 group-hover:bg-indigo-100 transition">
                                    <ShieldCheck className="w-10 h-10 text-indigo-600" />
                                </div>
                                <h2 className="text-xl font-bold text-gray-800">Administrador</h2>
                                <p className="text-sm text-gray-500 mt-2">Gestão e Validação</p>
                            </div>

                            <div onClick={() => handleRoleSelect('employee')} className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 cursor-pointer hover:border-green-500 hover:shadow-md transition-all group flex flex-col items-center text-center">
                                <div className="bg-green-50 p-4 rounded-full mb-4 group-hover:bg-green-100 transition">
                                    <UserCircle className="w-10 h-10 text-green-600" />
                                </div>
                                <h2 className="text-xl font-bold text-gray-800">Funcionário</h2>
                                <p className="text-sm text-gray-500 mt-2">Lançamentos e Produção</p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                    <Card className="w-full max-w-md relative border-0 shadow-xl">
                        <button onClick={handleBack} className="absolute top-6 left-6 text-gray-400 hover:text-gray-600 flex items-center text-xs font-medium uppercase tracking-wide">
                            <ArrowLeft className="w-3 h-3 mr-1" /> Voltar
                        </button>
                        <div className="text-center mb-8 mt-4">
                            <h1 className="text-2xl font-bold text-gray-800">Login {role === 'admin' ? 'Admin' : ''}</h1>
                            <p className="text-gray-500 text-sm">Entre com suas credenciais</p>
                        </div>

                        <form onSubmit={handleAuth}>
                            {isRegistering && (
                                <Input label="Nome Completo" placeholder="Seu nome" value={name} onChange={(e) => setName(e.target.value)} required />
                            )}
                            <Input label="E-mail" type="email" placeholder="email@exemplo.com" value={email} onChange={(e) => setEmail(e.target.value)} required />
                            <Input label="Senha" type="password" placeholder="******" value={password} onChange={(e) => setPassword(e.target.value)} required />
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 text-center border border-red-100">{error}</div>}
                            <Button type="primary" className={`w-full mb-3 h-10 ${role === 'admin' ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-green-600 hover:bg-green-700'}`} disabled={loading}>
                                {loading ? 'Aguarde...' : (isRegistering ? 'Criar Conta' : 'Acessar Sistema')}
                            </Button>
                        </form>
                        <div className="text-center mt-4 pt-4 border-t border-gray-100">
                            <button onClick={() => { setIsRegistering(!isRegistering); setError(''); }} className="text-sm text-gray-500 hover:text-indigo-600 transition-colors">
                                {isRegistering ? 'Já possui conta? Faça Login' : 'Não tem acesso? Crie sua conta aqui'}
                            </button>
                        </div>
                    </Card>
                </div>
            );
        };

        // ... (getScoreColor, RankingChart, DashboardContent, CalendarView mantidos iguais por brevidade, focando nas mudanças de formulário e botões) ...
        const getScoreColor = (score) => {
            if (score >= 90) return 'text-green-600 bg-green-50 border-green-200';
            if (score >= 75) return 'text-yellow-600 bg-yellow-50 border-yellow-200';
            return 'text-red-600 bg-red-50 border-red-200';
        };

        const RankingChart = ({ data }) => (
            <div className="space-y-3">
                {data.map((f, index) => (
                    <div key={f.id} className="p-3 bg-white border border-gray-100 rounded-lg hover:shadow-sm transition-shadow">
                        <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-semibold text-gray-700 flex items-center">
                                <span className="w-5 h-5 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center text-xs mr-2">{index + 1}</span>
                                {f.nome}
                            </span>
                            <span className={`text-xs font-bold px-2 py-0.5 rounded border ${getScoreColor(f.scoreGeral)}`}>{f.scoreGeral}%</span>
                        </div>
                        <div className="w-full bg-gray-100 rounded-full h-1.5 relative overflow-hidden">
                            <div className={`h-1.5 rounded-full ${f.scoreGeral >= 90 ? 'bg-green-500' : f.scoreGeral >= 75 ? 'bg-yellow-500' : 'bg-red-500'}`} style={{ width: `${f.scoreGeral}%` }}></div>
                        </div>
                        {f.totalPenalidades > 0 && (
                             <div className="mt-1 text-right text-[10px] text-red-500 font-medium flex justify-end items-center">
                                <Flag className="w-3 h-3 mr-1" /> -{f.totalPenalidades} pts
                             </div>
                        )}
                    </div>
                ))}
            </div>
        );

        const DashboardContent = ({ cargos, funcionarios, atividadesBase, lancamentos, clientes, bandeiras }) => {
            const dashboardData = useMemo(() => {
                const data = funcionarios.map(f => ({
                    ...f,
                    cargoNome: cargos.find(c => c.id === f.cargoId)?.nome || 'N/A',
                    totalPontosAtribuidos: 0, totalPontosMaximos: 0, lancamentosValidados: 0, totalPenalidades: 0, performancePorAtividade: {}
                }));

                lancamentos.filter(l => l.status === 'Validado').forEach(l => {
                    const funcIndex = data.findIndex(d => d.id === l.funcionarioId);
                    if (funcIndex === -1) return;
                    const atividadeBase = atividadesBase.find(a => a.id === l.atividadeBaseId);
                    const maxScore = atividadeBase?.pontuacaoMaxima || 1;
                    const ptsAtribuidos = Number(l.pontuacaoAtribuida || 0);
                    data[funcIndex].totalPontosAtribuidos += ptsAtribuidos;
                    data[funcIndex].totalPontosMaximos += maxScore;
                    data[funcIndex].lancamentosValidados += 1;
                    const atividadeId = l.atividadeBaseId;
                    if (!data[funcIndex].performancePorAtividade[atividadeId]) {
                        data[funcIndex].performancePorAtividade[atividadeId] = { nome: atividadeBase?.nome || 'Desconhecida', ptsAtribuidos: 0, ptsMaximos: 0 };
                    }
                    data[funcIndex].performancePorAtividade[atividadeId].ptsAtribuidos += ptsAtribuidos;
                    data[funcIndex].performancePorAtividade[atividadeId].ptsMaximos += maxScore;
                });

                bandeiras.forEach(b => {
                    const funcIndex = data.findIndex(d => d.id === b.funcionarioId);
                    if (funcIndex !== -1) {
                        data[funcIndex].totalPenalidades += 1;
                        data[funcIndex].totalPontosAtribuidos -= 1;
                    }
                });

                return data.map(d => {
                    const pontuacaoFinal = Math.max(0, d.totalPontosAtribuidos);
                    const score = d.totalPontosMaximos > 0 ? ((pontuacaoFinal / d.totalPontosMaximos) * 100).toFixed(0) : 0;
                    return { ...d, totalPontosAtribuidos: pontuacaoFinal, scoreGeral: score, performanceAtividades: Object.values(d.performancePorAtividade).map(pa => ({ ...pa, score: pa.ptsMaximos > 0 ? ((pa.ptsAtribuidos / pa.ptsMaximos) * 100).toFixed(0) : 0 })) };
                }).sort((a, b) => b.scoreGeral - a.scoreGeral);
            }, [funcionarios, cargos, atividadesBase, lancamentos, clientes, bandeiras]);

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <Card title="Ranking Geral" icon={BarChart3} className="md:col-span-1"><RankingChart data={dashboardData} /></Card>
                    <Card title="Detalhamento" icon={Users} className="md:col-span-2">
                        <div className="space-y-4 max-h-[70vh] overflow-y-auto pr-2 custom-scroll">
                            {dashboardData.map(f => (
                                <div key={f.id} className="p-4 border border-gray-100 rounded-xl bg-white hover:border-gray-200 transition-colors">
                                    <div className="flex justify-between items-center mb-3 border-b border-gray-50 pb-2">
                                        <span className="text-lg font-bold text-gray-800">{f.nome} <span className="text-xs font-normal text-gray-500 ml-2 bg-gray-100 px-2 py-0.5 rounded">{f.cargoNome}</span></span>
                                        <span className={`text-xl font-bold px-3 py-1 rounded-lg border ${getScoreColor(f.scoreGeral)}`}>{f.scoreGeral}%</span>
                                    </div>
                                    <div className="flex flex-wrap gap-4 text-sm text-gray-600">
                                        <span className="bg-gray-50 px-2 py-1 rounded">Pts: <b>{f.totalPontosAtribuidos}</b>/{f.totalPontosMaximos}</span>
                                        {f.totalPenalidades > 0 && <span className="text-red-600 font-bold flex items-center bg-red-50 px-2 py-1 rounded border border-red-100"><Flag className="w-3 h-3 mr-1" /> {f.totalPenalidades}</span>}
                                    </div>
                                </div>
                            ))}
                            {funcionarios.length === 0 && <div className="text-center p-6 text-gray-400 italic">Nenhum funcionário cadastrado.</div>}
                        </div>
                    </Card>
                </div>
            );
        };

        const CalendarView = ({ db, userId, funcionarios, lancamentos, bandeiras, selectedMonth }) => {
            const [selectedFuncionarioId, setSelectedFuncionarioId] = useState('');
            const [flagModalOpen, setFlagModalOpen] = useState(false);
            const [selectedDate, setSelectedDate] = useState(null);
            const [flagReason, setFlagReason] = useState('');
            const [loadingFlag, setLoadingFlag] = useState(false);

            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
            const year = parseInt(selectedMonth.split('-')[0]);
            const month = parseInt(selectedMonth.split('-')[1]) - 1;
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);
            const daysArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const blanksArray = Array.from({ length: firstDay }, (_, i) => i);

            const funcionarioLancamentos = useMemo(() => selectedFuncionarioId ? lancamentos.filter(l => l.funcionarioId === selectedFuncionarioId) : [], [lancamentos, selectedFuncionarioId]);
            const funcionarioBandeiras = useMemo(() => selectedFuncionarioId ? bandeiras.filter(b => b.funcionarioId === selectedFuncionarioId) : [], [bandeiras, selectedFuncionarioId]);

            const handleDayClick = (day) => {
                if (!selectedFuncionarioId) return;
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const existingFlag = funcionarioBandeiras.find(b => b.data === dateStr);
                if (existingFlag) {
                    if (window.confirm("Remover bandeira?")) deleteDoc(doc(db, getPublicCollectionPath('bandeiras'), existingFlag.id));
                } else {
                    setSelectedDate(dateStr);
                    setFlagModalOpen(true);
                }
            };

            const handleAddFlag = async () => {
                if (!db || !selectedFuncionarioId || !selectedDate) return;
                setLoadingFlag(true);
                try {
                    await addDoc(collection(db, getPublicCollectionPath('bandeiras')), { funcionarioId: selectedFuncionarioId, data: selectedDate, motivo: flagReason, criadoPor: userId, timestamp: serverTimestamp() });
                    setFlagModalOpen(false); setFlagReason('');
                } catch (e) { console.error(e); } finally { setLoadingFlag(false); }
            };

            return (
                <div className="space-y-6">
                    <Card title="Calendário e Penalidades" icon={CalendarIcon}>
                        <div className="mb-6">
                            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Funcionário</label>
                            <select value={selectedFuncionarioId} onChange={(e) => setSelectedFuncionarioId(e.target.value)} className="w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Selecione --</option>
                                {funcionarios.map(f => <option key={f.id} value={f.id}>{f.nome}</option>)}
                            </select>
                        </div>
                        {selectedFuncionarioId && (
                            <div className="border rounded-lg overflow-hidden bg-white shadow-sm">
                                <div className="grid grid-cols-7 bg-gray-50 border-b text-center py-2 text-xs font-semibold text-gray-500 uppercase">
                                    {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(d => <div key={d}>{d}</div>)}
                                </div>
                                <div className="grid grid-cols-7 bg-white">
                                    {blanksArray.map(b => <div key={`blank-${b}`} className="h-24 border-b border-r bg-gray-50/30"></div>)}
                                    {daysArray.map(day => {
                                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                        const hasLancamento = funcionarioLancamentos.some(l => l.dataConclusao === dateStr);
                                        const hasFlag = funcionarioBandeiras.find(b => b.data === dateStr);
                                        return (
                                            <div key={day} onClick={() => handleDayClick(day)} className="h-24 border-b border-r p-2 relative cursor-pointer transition-all hover:bg-gray-50 group">
                                                <span className={`text-sm font-medium ${hasFlag ? 'text-red-600' : 'text-gray-700'}`}>{day}</span>
                                                <div className="flex flex-col gap-1 mt-1">
                                                    {hasLancamento && <div className="flex items-center text-[10px] text-green-700 bg-green-50 border border-green-100 px-1 rounded"><Check className="w-3 h-3 mr-1" /> Entregue</div>}
                                                    {hasFlag && <div className="flex items-center text-[10px] text-red-700 bg-red-50 border border-red-100 px-1 rounded"><Flag className="w-3 h-3 mr-1" /> Penalidade</div>}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </Card>
                    {flagModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
                            <div className="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl">
                                <h3 className="text-lg font-bold text-red-600 mb-4 flex items-center"><AlertTriangle className="w-5 h-5 mr-2"/> Penalidade</h3>
                                <Input label="Motivo da Bandeira" value={flagReason} onChange={(e) => setFlagReason(e.target.value)} />
                                <div className="flex justify-end space-x-2 mt-4">
                                    <Button type="secondary" onClick={() => setFlagModalOpen(false)}>Cancelar</Button>
                                    <Button type="danger" onClick={handleAddFlag} disabled={loadingFlag}>Aplicar (-1 pt)</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- FORMULÁRIOS DE CADASTRO (COM DESIGN DELICADO E CADASTRO DE USUÁRIO REAL) ---
        
        // Form de Cargos
        const CargoForm = ({ db, userId, cargos }) => {
            const [nome, setNome] = useState('');
            const [editingCargo, setEditingCargo] = useState(null);
            const handleSubmit = async (e) => {
                e.preventDefault(); if(!nome.trim()) return;
                try {
                    if(editingCargo) await setDoc(doc(db, getPublicCollectionPath('cargos'), editingCargo.id), {...editingCargo, nome: nome.trim()}, {merge:true});
                    else await addDoc(collection(db, getPublicCollectionPath('cargos')), {nome: nome.trim(), criadoPor: userId, timestamp: serverTimestamp()});
                    setNome(''); setEditingCargo(null);
                } catch(e) { console.error(e); }
            };
            return (
                <Card title="Cargos" icon={Briefcase}>
                    <form onSubmit={handleSubmit} className="mb-6 flex gap-2 items-end">
                        <div className="flex-1"><Input label={editingCargo ? "Editando Cargo" : "Novo Cargo"} value={nome} onChange={e=>setNome(e.target.value)} placeholder="Ex: Designer" required className="mb-0" /></div>
                        <div className="mb-[1px]"><Button size="sm">{editingCargo ? 'Salvar' : 'Adicionar'}</Button></div>
                        {editingCargo && <div className="mb-[1px]"><Button type="secondary" size="sm" onClick={() => { setEditingCargo(null); setNome(''); }} icon={X}>Cancelar</Button></div>}
                    </form>
                    <ul className="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scroll">
                        {cargos.map(c => (
                            <li key={c.id} className="flex justify-between items-center p-2 bg-white border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors group">
                                <span className="text-sm text-gray-700">{c.nome}</span>
                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <Button type="ghost" size="icon" onClick={()=> {setEditingCargo(c); setNome(c.nome)}}><Pencil className="w-3 h-3 text-blue-600"/></Button>
                                    <Button type="ghost" size="icon" onClick={()=> {if(confirm('Excluir?')) deleteDoc(doc(db, getPublicCollectionPath('cargos'), c.id))}}><Trash2 className="w-3 h-3 text-red-500"/></Button>
                                </div>
                            </li>
                        ))}
                    </ul>
                </Card>
            );
        };

        // Form de Atividades
        const AtividadeBaseForm = ({ db, userId, cargos, atividadesBase }) => {
            const [nome, setNome] = useState(''); const [cargoId, setCargoId] = useState(''); const [peso, setPeso] = useState(1);
            const [editing, setEditing] = useState(null);
            const handleSubmit = async (e) => {
                e.preventDefault(); if(!nome || !cargoId) return;
                const data = { nome, cargoId, pontuacaoMaxima: Number(peso), criadoPor: userId };
                try {
                    if(editing) await setDoc(doc(db, getPublicCollectionPath('atividadesBase'), editing.id), data, {merge:true});
                    else await addDoc(collection(db, getPublicCollectionPath('atividadesBase')), {...data, timestamp: serverTimestamp()});
                    setNome(''); setCargoId(''); setPeso(1); setEditing(null);
                } catch(e){console.error(e);}
            };
            return (
                <Card title="Atividades" icon={ListTodo}>
                    <form onSubmit={handleSubmit} className="mb-6 space-y-3 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <Input label="Nome da Atividade" value={nome} onChange={e=>setNome(e.target.value)} placeholder="Ex: Criar Post" required className="bg-white"/>
                        <div className="flex gap-2">
                            <div className="w-2/3">
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Cargo</label>
                                <select value={cargoId} onChange={e=>setCargoId(e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500" required>
                                    <option value="">Selecione...</option>
                                    {cargos.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}
                                </select>
                            </div>
                            <div className="w-1/3">
                                <Input type="number" value={peso} onChange={e=>setPeso(e.target.value)} label="Peso" required className="bg-white" />
                            </div>
                        </div>
                        <div className="flex justify-end gap-2">
                            {editing && <Button type="secondary" size="sm" onClick={() => { setEditing(null); setNome(''); }}>Cancelar</Button>}
                            <Button size="sm">{editing ? 'Salvar' : 'Adicionar'}</Button>
                        </div>
                    </form>
                    <ul className="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scroll">
                        {atividadesBase.map(a => (
                            <li key={a.id} className="flex justify-between items-center p-2 bg-white border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors group">
                                <div>
                                    <span className="text-sm font-medium text-gray-700 block">{a.nome}</span>
                                    <span className="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">Max: {a.pontuacaoMaxima}pts</span>
                                </div>
                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <Button type="ghost" size="icon" onClick={()=>{setEditing(a); setNome(a.nome); setCargoId(a.cargoId); setPeso(a.pontuacaoMaxima)}}><Pencil className="w-3 h-3 text-blue-600"/></Button>
                                    <Button type="ghost" size="icon" onClick={()=>{if(confirm('Excluir?')) deleteDoc(doc(db, getPublicCollectionPath('atividadesBase'), a.id))}}><Trash2 className="w-3 h-3 text-red-500"/></Button>
                                </div>
                            </li>
                        ))}
                    </ul>
                </Card>
            );
        };

        const ClienteForm = ({ db, userId, clientes }) => {
            const [nome, setNome] = useState('');
            const [editing, setEditing] = useState(null);
            const handleSubmit = async (e) => {
                e.preventDefault(); if(!nome.trim()) return;
                try {
                    if(editing) await setDoc(doc(db, getPublicCollectionPath('clientes'), editing.id), { ...editing, nome: nome.trim() }, {merge:true});
                    else await addDoc(collection(db, getPublicCollectionPath('clientes')), { nome: nome.trim(), criadoPor: userId, timestamp: serverTimestamp() });
                    setNome(''); setEditing(null);
                } catch(e){console.error(e);}
            };
            return (
                <Card title="Clientes" icon={Building}>
                    <form onSubmit={handleSubmit} className="mb-6 flex gap-2 items-end">
                        <div className="flex-1"><Input label={editing ? "Editando" : "Novo Cliente"} value={nome} onChange={e=>setNome(e.target.value)} placeholder="Nome" required className="mb-0"/></div>
                        <div className="mb-[1px]"><Button size="sm">{editing ? 'OK' : '+'}</Button></div>
                        {editing && <div className="mb-[1px]"><Button type="secondary" size="sm" onClick={() => { setEditing(null); setNome(''); }} icon={X}>Cancelar</Button></div>}
                    </form>
                    <ul className="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scroll">
                        {clientes.map(c => (
                            <li key={c.id} className="flex justify-between items-center p-2 bg-white border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors group">
                                <span className="text-sm text-gray-700">{c.nome}</span>
                                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <Button type="ghost" size="icon" onClick={()=>{setEditing(c); setNome(c.nome)}}><Pencil className="w-3 h-3 text-blue-600"/></Button>
                                    <Button type="ghost" size="icon" onClick={()=>{if(confirm('Excluir?')) deleteDoc(doc(db, getPublicCollectionPath('clientes'), c.id))}}><Trash2 className="w-3 h-3 text-red-500"/></Button>
                                </div>
                            </li>
                        ))}
                    </ul>
                </Card>
            );
        };

        // --- NOVO FORMULÁRIO DE FUNCIONÁRIOS (CRIA LOGIN REAL) ---
        const FuncionarioForm = ({ db, userId, cargos, clientes, funcionarios }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [nome, setNome] = useState('');
            const [cargoId, setCargoId] = useState('');
            const [cliIds, setCliIds] = useState([]);
            const [isAdmin, setIsAdmin] = useState(false);
            const [loading, setLoading] = useState(false);
            const [creatingUser, setCreatingUser] = useState(false); // Toggle form mode

            // Cria usuário usando a App Secundária para não deslogar o Admin
            const handleCreateUser = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    // 1. Criar Auth na SecondaryApp
                    const userCred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                    const newUser = userCred.user;

                    // 2. Criar Doc no Firestore Principal
                    await setDoc(doc(db, getPublicCollectionPath('funcionarios'), newUser.uid), {
                        id: newUser.uid,
                        nome: nome,
                        email: email,
                        cargoId: cargoId,
                        clienteIds: cliIds,
                        isAdmin: isAdmin,
                        criadoPor: userId,
                        timestamp: serverTimestamp()
                    });

                    // 3. Logout da SecondaryApp para limpar sessão secundária
                    await signOut(secondaryAuth);

                    alert(`Funcionário ${nome} criado com sucesso! E-mail: ${email}`);
                    setNome(''); setEmail(''); setPassword(''); setCargoId(''); setCliIds([]); setIsAdmin(false); setCreatingUser(false);
                } catch (err) {
                    console.error(err);
                    alert("Erro ao criar usuário: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const toggleCli = (id) => setCliIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);

            return (
                <div className="md:col-span-3">
                    <Card title="Gestão de Funcionários" icon={Users}>
                        {!creatingUser ? (
                            <div className="flex justify-between items-center mb-4">
                                <p className="text-sm text-gray-500">Gerencie permissões e acessos.</p>
                                <Button onClick={() => setCreatingUser(true)} icon={UserPlus} size="sm">Novo Funcionário</Button>
                            </div>
                        ) : (
                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-6 animate-fade-in">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-gray-700">Cadastrar Novo Acesso</h3>
                                    <Button type="ghost" size="sm" onClick={() => setCreatingUser(false)} icon={X}>Fechar</Button>
                                </div>
                                <form onSubmit={handleCreateUser}>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <Input label="Nome" value={nome} onChange={e=>setNome(e.target.value)} required className="bg-white"/>
                                        <Input label="E-mail (Login)" type="email" value={email} onChange={e=>setEmail(e.target.value)} required className="bg-white"/>
                                        <Input label="Senha Temporária" type="password" value={password} onChange={e=>setPassword(e.target.value)} required className="bg-white"/>
                                        <div>
                                            <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Cargo</label>
                                            <select value={cargoId} onChange={e=>setCargoId(e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm" required>
                                                <option value="">Selecione...</option>
                                                {cargos.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Clientes Vinculados</label>
                                        <div className="flex flex-wrap gap-2 bg-white p-2 border rounded-lg">
                                            {clientes.map(c => (
                                                <label key={c.id} className={`cursor-pointer px-3 py-1 rounded-full text-xs border ${cliIds.includes(c.id) ? 'bg-indigo-100 border-indigo-300 text-indigo-700' : 'bg-gray-50 border-gray-200 text-gray-600'}`}>
                                                    <input type="checkbox" className="hidden" checked={cliIds.includes(c.id)} onChange={() => toggleCli(c.id)} />
                                                    {c.nome}
                                                </label>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="flex items-center justify-between mt-4 pt-4 border-t border-gray-200">
                                        <label className="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                                            <input type="checkbox" checked={isAdmin} onChange={e=>setIsAdmin(e.target.checked)} className="rounded text-indigo-600 focus:ring-indigo-500"/>
                                            Acesso Administrativo
                                        </label>
                                        <Button disabled={loading}>{loading ? 'Criando...' : 'Cadastrar Acesso'}</Button>
                                    </div>
                                </form>
                            </div>
                        )}

                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                                    <tr>
                                        <th className="px-4 py-3">Nome</th>
                                        <th className="px-4 py-3">E-mail</th>
                                        <th className="px-4 py-3">Cargo</th>
                                        <th className="px-4 py-3">Clientes</th>
                                        <th className="px-4 py-3">Permissão</th>
                                        <th className="px-4 py-3 text-right">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {funcionarios.map(f => (
                                        <tr key={f.id} className="border-b hover:bg-gray-50">
                                            <td className="px-4 py-3 font-medium text-gray-900">{f.nome}</td>
                                            <td className="px-4 py-3 text-gray-500">{f.email}</td>
                                            <td className="px-4 py-3">{cargos.find(c=>c.id===f.cargoId)?.nome || '-'}</td>
                                            <td className="px-4 py-3 text-xs text-gray-500 max-w-xs truncate">
                                                {f.clienteIds?.map(cid => clientes.find(cl=>cl.id===cid)?.nome).join(', ') || '-'}
                                            </td>
                                            <td className="px-4 py-3">
                                                {f.isAdmin ? <span className="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full font-bold">Admin</span> : <span className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">Func</span>}
                                            </td>
                                            <td className="px-4 py-3 text-right">
                                                {/* Edição simplificada (poderia abrir um modal aqui) */}
                                                <button onClick={() => { if(confirm('Excluir acesso deste funcionário?')) deleteDoc(doc(db, getPublicCollectionPath('funcionarios'), f.id)) }} className="text-red-500 hover:text-red-700">
                                                    <Trash2 className="w-4 h-4" />
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- LÓGICA DE VALIDAÇÃO (REFINADA) ---
        const ValidacaoLancamento = ({ db, userId, lancamentos, atividadesBase, funcionarios }) => {
            const pendentes = useMemo(() => lancamentos.filter(l => l.status === 'Pendente'), [lancamentos]);
            const [scoreMap, setScoreMap] = useState({});
            const [loadingMap, setLoadingMap] = useState({});

            useEffect(() => {
                const map = {};
                pendentes.forEach(l => { if (scoreMap[l.id] === undefined) map[l.id] = (atividadesBase.find(a => a.id === l.atividadeBaseId)?.pontuacaoMaxima || 1); });
                setScoreMap(prev => ({ ...prev, ...map }));
            }, [pendentes, atividadesBase]);

            const handleVal = async (l) => {
                setLoadingMap(p=>({...p, [l.id]: true}));
                try {
                    await setDoc(doc(db, getPublicCollectionPath('lancamentos'), l.id), { status: 'Validado', pontuacaoAtribuida: scoreMap[l.id], validadorId: userId }, {merge:true});
                } catch(e){console.error(e);} finally { setLoadingMap(p=>({...p, [l.id]: false})); }
            };

            if (pendentes.length === 0) return <div className="text-center p-8 bg-white rounded-xl border border-gray-200 text-gray-500">Tudo limpo! Nenhum lançamento pendente.</div>;

            return (
                <div className="space-y-3">
                    {pendentes.map(l => {
                        const atv = atividadesBase.find(a => a.id === l.atividadeBaseId) || {};
                        const func = funcionarios.find(f => f.id === l.funcionarioId) || {};
                        return (
                            <div key={l.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col sm:flex-row justify-between items-center gap-4">
                                <div className="flex-1">
                                    <p className="font-bold text-indigo-700 text-base">{atv.nome}</p>
                                    <p className="text-sm text-gray-600 mt-1">Funcionário: <span className="font-semibold">{func.nome}</span></p>
                                    <div className="flex items-center gap-3 mt-1 text-xs text-gray-400">
                                        <span className="flex items-center"><CalendarIcon className="w-3 h-3 mr-1"/> {formatDate(l.dataConclusao)}</span>
                                        {l.descricao && <span className="bg-gray-100 px-2 py-0.5 rounded text-gray-600 truncate max-w-[200px]">{l.descricao}</span>}
                                    </div>
                                </div>
                                <div className="flex gap-2 items-center bg-gray-50 p-2 rounded-lg">
                                    <span className="text-xs text-gray-500 font-bold uppercase mr-1">Nota:</span>
                                    <input type="number" max={atv.pontuacaoMaxima} value={scoreMap[l.id]||0} onChange={e=>setScoreMap(p=>({...p, [l.id]: e.target.value}))} className="w-12 text-center border rounded py-1 text-sm font-bold text-indigo-700 focus:ring-indigo-500 outline-none"/>
                                    <span className="text-xs text-gray-400">/ {atv.pontuacaoMaxima}</span>
                                    <Button size="sm" onClick={()=>handleVal(l)} disabled={loadingMap[l.id]} icon={Check}>Validar</Button>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const AdminView = ({ db, userId, cargos, funcionarios, atividadesBase, lancamentos, clientes, bandeiras, onLogout, selectedMonth, setSelectedMonth }) => {
            const [tab, setTab] = useState('dashboard');
            return (
                <div className="p-6 min-h-screen max-w-7xl mx-auto">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-200">
                        <h1 className="text-3xl font-extrabold text-gray-800 flex items-center tracking-tight"><Settings className="mr-3 text-indigo-600"/> Painel Admin</h1>
                        <div className="flex gap-4 items-center mt-4 md:mt-0">
                            <MonthSelector selectedMonth={selectedMonth} setSelectedMonth={setSelectedMonth} />
                            <Button onClick={onLogout} type="secondary" icon={LogOut} size="sm">Sair</Button>
                        </div>
                    </header>
                    <div className="flex gap-2 mb-8 overflow-x-auto pb-2 no-scrollbar">
                        {[
                            { id: 'dashboard', icon: BarChart3, label: 'Dashboard' },
                            { id: 'calendario', icon: CalendarIcon, label: 'Calendário' },
                            { id: 'validacao', icon: ClipboardList, label: 'Validação' },
                            { id: 'cadastros', icon: Briefcase, label: 'Cadastros' },
                        ].map(t => (
                            <button key={t.id} onClick={() => setTab(t.id)} className={`px-5 py-2.5 rounded-full text-sm font-medium flex items-center whitespace-nowrap transition-all ${tab === t.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-gray-600 hover:bg-gray-100 border border-gray-200'}`}>
                                <t.icon className="w-4 h-4 mr-2" /> {t.label}
                            </button>
                        ))}
                    </div>
                    <div className="animate-fade-in">
                        {tab === 'dashboard' && <DashboardContent cargos={cargos} funcionarios={funcionarios} atividadesBase={atividadesBase} lancamentos={lancamentos} clientes={clientes} bandeiras={bandeiras} />}
                        {tab === 'calendario' && <CalendarView db={db} userId={userId} funcionarios={funcionarios} lancamentos={lancamentos} bandeiras={bandeiras} selectedMonth={selectedMonth} />}
                        {tab === 'validacao' && <ValidacaoLancamento db={db} userId={userId} lancamentos={lancamentos} atividadesBase={atividadesBase} funcionarios={funcionarios} />}
                        {tab === 'cadastros' && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="md:col-span-1 space-y-6">
                                    <CargoForm db={db} userId={userId} cargos={cargos} />
                                    <AtividadeBaseForm db={db} userId={userId} cargos={cargos} atividadesBase={atividadesBase} />
                                    <ClienteForm db={db} userId={userId} clientes={clientes} />
                                </div>
                                <FuncionarioForm db={db} userId={userId} cargos={cargos} clientes={clientes} funcionarios={funcionarios} />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const EditLancamentoModal = ({ db, lancamento, onClose, atividadesDoCargo, clientesDoFuncionario }) => {
            const [selAtv, setSelAtv] = useState(lancamento.atividadeBaseId);
            const [selCli, setSelCli] = useState(lancamento.clienteId || '');
            const [desc, setDesc] = useState(lancamento.descricao);
            const [date, setDate] = useState(lancamento.dataConclusao);
            
            const handleSave = async (e) => {
                e.preventDefault();
                try {
                    await setDoc(doc(db, getPublicCollectionPath('lancamentos'), lancamento.id), {
                        atividadeBaseId: selAtv, clienteId: selCli, descricao: desc, dataConclusao: date
                    }, {merge:true});
                    onClose();
                } catch(e){console.error(e);}
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
                    <div className="bg-white p-6 rounded-xl w-full max-w-lg relative shadow-2xl">
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                            <h2 className="text-lg font-bold text-gray-800">Editar Lançamento</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X className="w-5 h-5"/></button>
                        </div>
                        <form onSubmit={handleSave}>
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Cliente</label>
                                <select value={selCli} onChange={e=>setSelCli(e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm">
                                    <option value="">Selecione...</option>
                                    {clientesDoFuncionario?.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}
                                </select>
                            </div>
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Atividade</label>
                                <select value={selAtv} onChange={e=>setSelAtv(e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm" required>
                                    <option value="">Selecione...</option>
                                    {atividadesDoCargo?.map(a=><option key={a.id} value={a.id}>{a.nome}</option>)}
                                </select>
                            </div>
                            <Input label="Data de Conclusão" type="date" value={date} onChange={e=>setDate(e.target.value)} required />
                            <div className="mb-6">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Descrição</label>
                                <textarea value={desc} onChange={e=>setDesc(e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500" rows="3"></textarea>
                            </div>
                            <div className="flex justify-end gap-2">
                                <Button type="secondary" onClick={onClose}>Cancelar</Button>
                                <Button>Salvar Alterações</Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const LancarAtividade = ({ db, userId, funcionario, atividadesBase, lancamentos, clientes }) => {
            const [selAtv, setSelAtv] = useState('');
            const [selCli, setSelCli] = useState('');
            const [desc, setDesc] = useState('');
            const [date, setDate] = useState('');
            const [editL, setEditL] = useState(null);

            const atvs = useMemo(() => funcionario ? atividadesBase.filter(a => a.cargoId === funcionario.cargoId) : [], [atividadesBase, funcionario]);
            const clis = useMemo(() => funcionario && funcionario.clienteIds ? clientes.filter(c => funcionario.clienteIds.includes(c.id)) : [], [clientes, funcionario]);
            const meusLancs = useMemo(() => lancamentos.filter(l => l.funcionarioId === userId).sort((a,b) => (b.dataLancamento?.toDate()||0) - (a.dataLancamento?.toDate()||0)), [lancamentos, userId]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, getPublicCollectionPath('lancamentos')), {
                        funcionarioId: userId, atividadeBaseId: selAtv, clienteId: selCli, descricao: desc, dataConclusao: date,
                        dataLancamento: serverTimestamp(), status: 'Pendente', pontuacaoAtribuida: 0
                    });
                    setDesc(''); setSelAtv(''); setSelCli(''); setDate('');
                } catch(e){console.error(e);}
            };

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <Card title="Novo Lançamento" icon={Plus}>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Cliente</label>
                                <select value={selCli} onChange={e=>setSelCli(e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm">
                                    <option value="">Selecione (Opcional)</option>
                                    {clis.map(c=><option key={c.id} value={c.id}>{c.nome}</option>)}
                                </select>
                            </div>
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Atividade</label>
                                <select value={selAtv} onChange={e=>setSelAtv(e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm" required>
                                    <option value="">Selecione</option>
                                    {atvs.map(a=><option key={a.id} value={a.id}>{a.nome}</option>)}
                                </select>
                            </div>
                            <Input label="Data" type="date" value={date} onChange={e=>setDate(e.target.value)} required />
                            <div className="mb-4">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Detalhes</label>
                                <textarea value={desc} onChange={e=>setDesc(e.target.value)} className="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm" placeholder="Opcional..." rows="3"></textarea>
                            </div>
                            <Button className="w-full">Lançar Atividade</Button>
                        </form>
                    </Card>
                    <Card title="Histórico Recente" icon={ClipboardList} className="md:col-span-2">
                        <div className="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scroll">
                            {meusLancs.map(l => (
                                <div key={l.id} className="p-3 border border-gray-100 rounded-lg bg-white hover:border-indigo-200 transition-colors flex justify-between items-center">
                                    <div>
                                        <span className="font-semibold text-gray-700 block">{atividadesBase.find(a => a.id === l.atividadeBaseId)?.nome || '?'}</span>
                                        <div className="flex items-center gap-2 mt-1">
                                            <span className={`text-[10px] px-2 py-0.5 rounded-full border ${l.status === 'Validado' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-yellow-50 border-yellow-200 text-yellow-700'}`}>{l.status}</span>
                                            <span className="text-xs text-gray-400">{formatDate(l.dataConclusao)}</span>
                                        </div>
                                    </div>
                                    {l.status === 'Pendente' && (
                                        <div className="flex gap-1">
                                            <Button type="ghost" size="icon" onClick={()=>setEditL(l)}><Pencil className="w-4 h-4 text-blue-500"/></Button>
                                            <Button type="ghost" size="icon" onClick={()=>deleteDoc(doc(db, getPublicCollectionPath('lancamentos'), l.id))}><Trash2 className="w-4 h-4 text-red-500"/></Button>
                                        </div>
                                    )}
                                </div>
                            ))}
                            {meusLancs.length === 0 && <p className="text-center text-gray-400 text-sm py-4">Nenhum lançamento neste mês.</p>}
                        </div>
                    </Card>
                    {editL && <EditLancamentoModal db={db} lancamento={editL} onClose={()=>setEditL(null)} atividadesDoCargo={atvs} clientesDoFuncionario={clis} />}
                </div>
            );
        };

        const EmployeeView = ({ db, userId, funcionario, cargos, atividadesBase, lancamentos, clientes, bandeiras, onLogout, selectedMonth, setSelectedMonth }) => {
            const cargoNome = useMemo(() => cargos.find(c => c.id === funcionario?.cargoId)?.nome || 'N/A', [cargos, funcionario]);
            const minhasBandeiras = useMemo(() => bandeiras.filter(b => b.funcionarioId === userId && (!selectedMonth || b.data.startsWith(selectedMonth))), [bandeiras, userId, selectedMonth]);

            return (
                <div className="p-6 min-h-screen max-w-7xl mx-auto">
                    <header className="flex justify-between items-center mb-8 pb-4 border-b border-gray-200">
                        <h1 className="text-2xl font-bold text-indigo-800 flex items-center tracking-tight"><User className="mr-2"/> Olá, {funcionario?.nome}</h1>
                        <div className="flex gap-4 items-center">
                            <MonthSelector selectedMonth={selectedMonth} setSelectedMonth={setSelectedMonth} />
                            <Button onClick={onLogout} type="secondary" icon={LogOut} size="sm">Sair</Button>
                        </div>
                    </header>
                    <div className="mb-8">
                        <Card className="bg-gradient-to-r from-indigo-50 to-white border-indigo-100">
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="text-sm text-gray-500 uppercase font-bold">Seu Cargo</p>
                                    <p className="text-2xl font-bold text-indigo-700">{cargoNome}</p>
                                </div>
                                {minhasBandeiras.length > 0 && (
                                    <div className="bg-red-50 border border-red-200 px-4 py-2 rounded-lg text-red-700 flex items-center shadow-sm">
                                        <AlertTriangle className="w-5 h-5 mr-2"/> 
                                        <div>
                                            <p className="font-bold text-sm">Atenção</p>
                                            <p className="text-xs">{minhasBandeiras.length} penalidade(s) este mês</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </Card>
                    </div>
                    <LancarAtividade db={db} userId={userId} funcionario={funcionario} atividadesBase={atividadesBase} lancamentos={lancamentos} clientes={clientes} />
                </div>
            );
        };

        // --- APP ROOT ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().substring(0, 7));
            const [targetRole, setTargetRole] = useState(null);

            // Data States
            const [cargos, setCargos] = useState([]);
            const [atividades, setAtividades] = useState([]);
            const [funcs, setFuncs] = useState([]);
            const [lancs, setLancs] = useState([]);
            const [clis, setClis] = useState([]);
            const [flags, setFlags] = useState([]);

            useEffect(() => {
                return onAuthStateChanged(auth, u => {
                    setUser(u);
                    if(!u) { setProfile(null); setLoadingAuth(false); setTargetRole(null); }
                });
            }, []);

            useEffect(() => {
                if(user) {
                    const unsubP = onSnapshot(doc(db, getPublicCollectionPath('funcionarios'), user.uid), d => {
                        if(d.exists()) {
                            const data = d.data();
                            // FORÇA SUPER ADMIN
                            if (SUPER_ADMINS.includes(data.email)) data.isAdmin = true;
                            setProfile(data);
                        } else {
                            const isSuper = SUPER_ADMINS.includes(user.email);
                            setProfile({ id: user.uid, nome: user.email, isAdmin: isSuper });
                        }
                        setLoadingAuth(false);
                    });

                    const uC = onSnapshot(query(collection(db, getPublicCollectionPath('cargos'))), s => setCargos(s.docs.map(d=>({id:d.id, ...d.data()}))));
                    const uA = onSnapshot(query(collection(db, getPublicCollectionPath('atividadesBase'))), s => setAtividades(s.docs.map(d=>({id:d.id, ...d.data()}))));
                    const uF = onSnapshot(query(collection(db, getPublicCollectionPath('funcionarios'))), s => setFuncs(s.docs.map(d=>({id:d.id, ...d.data()}))));
                    const uL = onSnapshot(query(collection(db, getPublicCollectionPath('lancamentos'))), s => setLancs(s.docs.map(d=>({id:d.id, ...d.data()}))));
                    const uCl = onSnapshot(query(collection(db, getPublicCollectionPath('clientes'))), s => setClis(s.docs.map(d=>({id:d.id, ...d.data()}))));
                    const uFl = onSnapshot(query(collection(db, getPublicCollectionPath('bandeiras'))), s => setFlags(s.docs.map(d=>({id:d.id, ...d.data()}))));
                    
                    return () => { unsubP(); uC(); uA(); uF(); uL(); uCl(); uFl(); }
                }
            }, [user]);

            const handleLogout = () => {
                signOut(auth);
                setTargetRole(null);
            };

            const filteredLancs = useMemo(() => lancs.filter(l => !l.dataConclusao || l.dataConclusao.startsWith(selectedMonth)), [lancs, selectedMonth]);
            const filteredFlags = useMemo(() => flags.filter(f => !f.data || f.data.startsWith(selectedMonth)), [flags, selectedMonth]);

            if(loadingAuth) return <div className="flex h-screen items-center justify-center text-indigo-600 text-xl font-bold animate-pulse">Carregando SAP...</div>;

            if(!user) return <LoginScreen setTargetRole={setTargetRole} />;

            if (targetRole === 'admin' && !profile?.isAdmin) {
                return (
                    <div className="flex h-screen flex-col items-center justify-center bg-gray-50 text-center p-6">
                        <div className="bg-red-100 p-4 rounded-full mb-4"><AlertTriangle className="w-12 h-12 text-red-600" /></div>
                        <h1 className="text-2xl font-bold text-gray-800 mb-2">Acesso Restrito</h1>
                        <p className="text-gray-600 mb-6">Esta conta não possui privilégios administrativos.</p>
                        <Button onClick={handleLogout} type="danger">Sair e Tentar Novamente</Button>
                    </div>
                );
            }

            if(targetRole === 'admin' && profile?.isAdmin) {
                return <AdminView db={db} userId={user.uid} cargos={cargos} funcionarios={funcs} atividadesBase={atividades} lancamentos={filteredLancs} clientes={clis} bandeiras={filteredFlags} onLogout={handleLogout} selectedMonth={selectedMonth} setSelectedMonth={setSelectedMonth} />;
            }
            
            return <EmployeeView db={db} userId={user.uid} funcionario={profile} cargos={cargos} atividadesBase={atividades} lancamentos={filteredLancs} clientes={clis} bandeiras={filteredFlags} onLogout={handleLogout} selectedMonth={selectedMonth} setSelectedMonth={setSelectedMonth} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
